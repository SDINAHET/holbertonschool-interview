name: Wild Compare CI

on:
  push:
    paths:
      - "wild_cmp/**"
      - ".github/workflows/wild_cmp.yml"
  pull_request:
    paths:
      - "wild_cmp/**"
      - ".github/workflows/wild_cmp.yml"
  workflow_dispatch:

jobs:
  build:
    name: Wild Compare / Compile + Lint (C, Ubuntu 22.04)
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify required files
        run: |
          test -d wild_cmp || (echo "âŒ Missing wild_cmp directory" && exit 1)
          test -f wild_cmp/0-wildcmp.c || (echo "âŒ Missing 0-wildcmp.c" && exit 1)
          test -f wild_cmp/holberton.h || (echo "âŒ Missing holberton.h" && exit 1)
          echo "âœ… All required files are present"

      - name: Install dependencies (build tools + Betty)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential git
          echo "â¬‡ï¸ Installing Betty linter..."
          git clone https://github.com/holbertonschool/Betty.git
          cd Betty && sudo ./install.sh
          echo "âœ… Betty installed"

      - name: Run Betty style check
        run: |
          echo "ğŸ” Running Betty..."
          betty wild_cmp/*.c wild_cmp/*.h || (echo "âŒ Betty style errors found" && exit 1)
          echo "âœ… Betty style passed"

      - name: Compile (prefer 0-main.c if present)
        shell: bash
        run: |
          set -e
          echo "ğŸ—ï¸ Compiling with -Wall -Werror -Wextra -pedantic"
          if [ -f "wild_cmp/0-main.c" ]; then
            gcc -Wall -Wextra -Werror -pedantic \
              wild_cmp/0-wildcmp.c wild_cmp/0-main.c \
              -I wild_cmp -o wild_cmp/wild_cmp_test
          else
            # GÃ©nÃ¨re _stub_main.c sans heredoc
            printf '%s\n' \
              '#include "holberton.h"' \
              '#include <stdio.h>' \
              'int main(void)' \
              '{' \
              '    printf("%d\n", wildcmp("main.c", "*.c"));' \
              '    printf("%d\n", wildcmp("main.c", "m*a*i*n*.*c*"));' \
              '    printf("%d\n", wildcmp("main.c", "main.c"));' \
              '    printf("%d\n", wildcmp("main.c", "m*c"));' \
              '    printf("%d\n", wildcmp("main.c", "ma********************************c"));' \
              '    printf("%d\n", wildcmp("main.c", "*"));' \
              '    printf("%d\n", wildcmp("main.c", "***"));' \
              '    printf("%d\n", wildcmp("main.c", "m.*c"));' \
              '    printf("%d\n", wildcmp("main.c", "**.*c"));' \
              '    printf("%d\n", wildcmp("main-main.c", "ma*in.c"));' \
              '    printf("%d\n", wildcmp("main", "main*d"));' \
              '    printf("%d\n", wildcmp("abc", "*b"));' \
              '    return (0);' \
              '}' \
              > wild_cmp/_stub_main.c

            gcc -Wall -Wextra -Werror -pedantic \
              wild_cmp/0-wildcmp.c wild_cmp/_stub_main.c \
              -I wild_cmp -o wild_cmp/wild_cmp_test
          fi
          echo "âœ… Compilation successful"

      - name: Run program (subject sequence)
        run: |
          echo "ğŸš€ Running subject sequence..."
          ./wild_cmp/wild_cmp_test > wild_cmp/_actual.txt
          echo "âœ… Program executed successfully"

      - name: Validate EXACT output (12 lines)
        shell: bash
        run: |
          # Sortie attendue 'sujet'
          printf '%s\n' 1 1 1 1 1 1 1 0 1 1 0 0 > wild_cmp/_expected.txt
          echo "ğŸ” Comparing output with expected (subject)..."
          diff -u wild_cmp/_expected.txt wild_cmp/_actual.txt
          echo "âœ… Exact output match (subject)."

      - name: Build and run checker-like cases
        shell: bash
        run: |
          # GÃ©nÃ¨re un main de tests 'checker-like' sans heredoc
          printf '%s\n' \
            '#include "holberton.h"' \
            '#include <stdio.h>' \
            'int main(void)' \
            '{' \
            '    printf("%d\n", wildcmp("holberton.c", "*.c"));' \
            '    printf("%d\n", wildcmp("holberton.c", "*h*o*l*b*e*r*t*o*n*.*c*"));' \
            '    printf("%d\n", wildcmp("holberton.c", "holberton.c"));' \
            '    printf("%d\n", wildcmp("holberton.c", "h*c"));' \
            '    printf("%d\n", wildcmp("holberton.c", "hol********************************c"));' \
            '    printf("%d\n", wildcmp("holberton.c", "*"));' \
            '    printf("%d\n", wildcmp("holberton.c", "***"));' \
            '    printf("%d\n", wildcmp("holberton.c", "h.*c"));' \
            '    printf("%d\n", wildcmp("holberton.c", "**.*c"));' \
            '    printf("%d\n", wildcmp("holberton-holberton.c", "holbe*rton.c"));' \
            '    printf("%d\n", wildcmp("holberton", "holberton*d"));' \
            '    printf("%d\n", wildcmp("def", "*e"));' \
            '    printf("%d\n", wildcmp("", "*"));' \
            '    return (0);' \
            '}' \
            > wild_cmp/_checker_main.c

          gcc -Wall -Wextra -Werror -pedantic \
            wild_cmp/0-wildcmp.c wild_cmp/_checker_main.c \
            -I wild_cmp -o wild_cmp/_checker

          ./wild_cmp/_checker > wild_cmp/_actual_checker.txt

          # Sortie attendue pour ces 13 cas (ordre identique au printf ci-dessus)
          printf '%s\n' 1 1 1 1 1 1 1 0 1 1 0 1 1 > wild_cmp/_expected_checker.txt

          echo "ğŸ” Comparing output with expected (checker-like)..."
          diff -u wild_cmp/_expected_checker.txt wild_cmp/_actual_checker.txt
          echo "âœ… Exact output match (checker-like)."

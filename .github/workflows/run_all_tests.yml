name: Run all tests (autodiscovery)

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  trigger-all:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch every other workflow on this branch
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // ref sûre (ex: main, develop, …)
            const refName = process.env.GITHUB_REF_NAME
              || (context.ref || '').replace('refs/heads/', '')
              || 'main';

            // Lister tous les workflows (renvoie directement un array de workflows)
            const workflows = await github.paginate(
              github.rest.actions.listRepoWorkflows,
              { owner, repo, per_page: 100 }
            );

            const thisWorkflowName = process.env.GITHUB_WORKFLOW;

            // helper: récupère le contenu YAML pour vérifier la présence de workflow_dispatch
            async function hasWorkflowDispatch(path) {
              try {
                const res = await github.rest.repos.getContent({ owner, repo, path });
                const buf = Buffer.from(res.data.content, res.data.encoding || 'base64');
                const text = buf.toString('utf8');
                return /(^|\n)\s*on:\s*([\s\S]*?)workflow_dispatch\s*:/m.test(text);
              } catch (e) {
                core.warning(`Cannot read ${path}: ${e.message}`);
                return false;
              }
            }

            // Filtrer les candidats actifs, pas ce lanceur, et situés dans .github/workflows
            const active = workflows.filter(wf =>
              wf.state === 'active' &&
              wf.path?.startsWith('.github/workflows/') &&
              wf.name !== thisWorkflowName
            );

            core.info(`Found ${active.length} active workflows. Checking triggers...`);

            let dispatched = 0, skipped = 0, failed = 0;

            for (const wf of active) {
              const canDispatch = await hasWorkflowDispatch(wf.path);
              if (!canDispatch) {
                core.info(`⏭️  Skip (no workflow_dispatch): ${wf.name} (${wf.path})`);
                skipped++;
                continue;
              }
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner, repo,
                  workflow_id: wf.id,  // ID numérique = plus fiable
                  ref: refName
                });
                core.info(`✅ Dispatched: ${wf.name} (id=${wf.id}) on ref: ${refName}`);
                dispatched++;
              } catch (e) {
                core.warning(`⚠️ Failed: ${wf.name} (id=${wf.id}) → ${e.status || ''} ${e.message}`);
                failed++;
              }
            }

            core.info(`Summary → dispatched=${dispatched}, skipped(no dispatch trigger)=${skipped}, failed=${failed}`);

name: Run all tests (autodiscovery)

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  trigger-all:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch every other workflow on this branch
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            // ref_name = "main", "develop", etc. (fallback si non dispo)
            const refName = context.ref_name || context.ref.replace('refs/heads/', '');

            // Lister tous les workflows actifs du dépôt
            const all = await github.paginate(
              github.rest.actions.listRepoWorkflows,
              { owner, repo, per_page: 100 }
            );

            // Identifier ce workflow pour ne pas se relancer lui-même
            // (GitHub fournit context.workflow, mais on filtre par chemin si dispo)
            const thisWorkflowName = process.env.GITHUB_WORKFLOW; // "Run all tests (autodiscovery)"

            // Ne garder que les workflows actifs et différents du lanceur
            const candidates = all.filter(wf =>
              wf.state === 'active' &&
              wf.name !== thisWorkflowName
            );

            core.info(`Found ${candidates.length} candidate workflows.`);

            let ok = 0, fail = 0;
            for (const wf of candidates) {
              try {
                // IMPORTANT : utiliser l'ID numérique du workflow
                await github.rest.actions.createWorkflowDispatch({
                  owner, repo,
                  workflow_id: wf.id,
                  ref: refName
                });
                core.info(`Dispatched: ${wf.name} (id=${wf.id}) on ref: ${refName}`);
                ok++;
              } catch (e) {
                core.warning(`Failed to dispatch ${wf.name} (id=${wf.id}): ${e.message}`);
                fail++;
              }
            }
            core.info(`Done. Dispatched=${ok}, Failed=${fail}`);

name: Run all tests (autodiscovery)

on:
  workflow_dispatch:
  push:
    branches: [ "**" ]     # déclenche sur push vers n'importe quelle branche
    paths:    [ "**" ]     # déclenche quel que soit le dossier modifié

permissions:
  actions: write
  contents: read

# évite d'avoir plusieurs runs concurrents si tu pushes en rafale
concurrency:
  group: run-all-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  trigger-all:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch every other workflow on this branch
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const refName = process.env.GITHUB_REF_NAME
              || (context.ref || '').replace('refs/heads/', '')
              || 'main';

            const workflows = await github.paginate(
              github.rest.actions.listRepoWorkflows,
              { owner, repo, per_page: 100 }
            );

            const thisWorkflowName = process.env.GITHUB_WORKFLOW;

            async function hasWorkflowDispatch(path) {
              try {
                const res = await github.rest.repos.getContent({ owner, repo, path });
                const buf = Buffer.from(res.data.content, res.data.encoding || 'base64');
                const text = buf.toString('utf8');
                return /(^|\n)\s*on:\s*([\s\S]*?)workflow_dispatch\s*:/m.test(text);
              } catch (e) {
                core.warning(`Cannot read ${path}: ${e.message}`);
                return false;
              }
            }

            const active = workflows.filter(wf =>
              wf.state === 'active' &&
              wf.path?.startsWith('.github/workflows/') &&
              wf.name !== thisWorkflowName
            );

            core.info(`Found ${active.length} active workflows. Checking triggers...`);

            let dispatched = 0, skipped = 0, failed = 0;

            for (const wf of active) {
              const canDispatch = await hasWorkflowDispatch(wf.path);
              if (!canDispatch) {
                core.info(`⏭️  Skip (no workflow_dispatch): ${wf.name} (${wf.path})`);
                skipped++;
                continue;
              }
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner, repo,
                  workflow_id: wf.id,
                  ref: refName
                });
                core.info(`✅ Dispatched: ${wf.name} on ref: ${refName}`);
                dispatched++;
              } catch (e) {
                core.warning(`⚠️ Failed: ${wf.name} → ${e.status || ''} ${e.message}`);
                failed++;
              }
            }

            core.info(`Summary → dispatched=${dispatched}, skipped=${skipped}, failed=${failed}`);

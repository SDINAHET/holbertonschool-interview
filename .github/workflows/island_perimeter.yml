name: Island Perimeter CI

on:
  push:
    paths:
      - "island_perimeter/**"
      - ".github/workflows/island_perimeter.yml"
  pull_request:
    paths:
      - "island_perimeter/**"
      - ".github/workflows/island_perimeter.yml"

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    # On ex√©cute tout dans un conteneur Python 3.4 pour coller au checker Holberton
    container:
      image: python:3.4

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure expected paths exist
        run: |
          test -d island_perimeter || (echo "Missing island_perimeter directory" && exit 1)

      - name: Verify README exists at repo root
        run: |
          test -f README.md || (echo "Missing README.md at repository root" && exit 1)

      - name: Verify target file exists
        run: |
          test -f island_perimeter/0-island_perimeter.py || (echo "Missing island_perimeter/0-island_perimeter.py" && exit 1)
          test -f island_perimeter/0-main.py || (echo "Missing island_perimeter/0-main.py" && exit 1)

      - name: Verify first line shebang
        run: |
          head -n1 island_perimeter/0-island_perimeter.py | grep -qx '#!/usr/bin/python3' \
            || (echo "First line must be exactly '#!/usr/bin/python3'" && exit 1)
          head -n1 island_perimeter/0-main.py | grep -qx '#!/usr/bin/python3' \
            || (echo "First line of 0-main.py must be exactly '#!/usr/bin/python3'" && exit 1)

      - name: Verify file is executable
        run: |
          test -x island_perimeter/0-island_perimeter.py \
            || (echo "0-island_perimeter.py must be executable (chmod +x)" && exit 1)
          test -x island_perimeter/0-main.py \
            || (echo "0-main.py must be executable (chmod +x)" && exit 1)

      - name: Verify file ends with newline
        run: |
          tail -c1 island_perimeter/0-island_perimeter.py | od -An -t x1 | grep -q '0a' \
            || (echo "0-island_perimeter.py must end with a newline" && exit 1)
          tail -c1 island_perimeter/0-main.py | od -An -t x1 | grep -q '0a' \
            || (echo "0-main.py must end with a newline" && exit 1)

      - name: Enforce 'no imports' rule
        run: |
          if grep -nE '^\s*(from|import)\s+' island_perimeter/0-island_perimeter.py; then
            echo "No imports allowed in 0-island_perimeter.py"
            exit 1
          fi

      - name: Install pep8 (PEP8 1.7)
        run: |
          pip install --upgrade pip
          pip install "pep8==1.7.0"

      - name: Run PEP8 (pep8 1.7.0)
        run: |
          pep8 --version
          pep8 --show-source --show-pep8 island_perimeter/0-island_perimeter.py island_perimeter/0-main.py

      - name: Verify docstrings on module and function
        run: |
          python - << 'PY'
          import importlib.util, sys, os
          p = os.path.abspath('island_perimeter/0-island_perimeter.py')
          spec = importlib.util.spec_from_file_location('island', p)
          mod = importlib.util.module_from_spec(spec)
          spec.loader.exec_module(mod)
          assert (mod.__doc__ or '').strip(), "Module docstring is required"
          f = getattr(mod, 'island_perimeter', None)
          assert callable(f), "Function 'island_perimeter' not found"
          assert (f.__doc__ or '').strip(), "Function 'island_perimeter' must have a docstring"
          print("Docstrings OK")
          PY

      - name: Run sample test (expected output 12)
        run: |
          set -e
          echo "Running 0-main.py"
          out="$(python3 island_perimeter/0-main.py)"
          echo "Output: $out"
          test "$out" = "12" || (echo "Expected output '12' but got '$out'" && exit 1)

      - name: Smoke import and call
        run: |
          python3 - << 'PY'
          import importlib.util, os
          p = os.path.abspath('island_perimeter/0-island_perimeter.py')
          spec = importlib.util.spec_from_file_location('island', p)
          mod = importlib.util.module_from_spec(spec)
          spec.loader.exec_module(mod)
          grid = [
              [0,0,0,0,0,0],
              [0,1,0,0,0,0],
              [0,1,0,0,0,0],
              [0,1,1,1,0,0],
              [0,0,0,0,0,0]
          ]
          assert mod.island_perimeter(grid) == 12
          print("Function output OK")
          PY

name: AVL Trees CI

on:
  push:
    paths:
      - "avl_trees/**"
      - ".github/workflows/avl_trees.yml"
  pull_request:
    paths:
      - "avl_trees/**"
      - ".github/workflows/avl_trees.yml"

jobs:
  build:
    name: AVL Trees CI / Compile + Run (C, Ubuntu 22.04)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify required files
        run: |
          test -d avl_trees || (echo "âŒ Missing avl_trees directory" && exit 1)
          test -f avl_trees/0-binary_tree_is_avl.c || (echo "âŒ Missing 0-binary_tree_is_avl.c" && exit 1)
          test -f avl_trees/binary_tree_print.c || (echo "âŒ Missing binary_tree_print.c" && exit 1)
          test -f avl_trees/binary_tree_node.c || (echo "âŒ Missing binary_tree_node.c" && exit 1)
          test -f avl_trees/binary_trees.h || (echo "âŒ Missing binary_trees.h" && exit 1)
          test -f avl_trees/0-main.c || (echo "âŒ Missing 0-main.c" && exit 1)
          echo "âœ… All required files are present"

      - name: Install dependencies (build tools + Betty)
        run: |
          sudo apt update -y
          sudo apt install -y build-essential git
          echo "â¬‡ï¸ Installing Betty linter..."
          git clone https://github.com/holbertonschool/Betty.git
          cd Betty && sudo ./install.sh

      - name: Run Betty style check
        run: |
          echo "ğŸ” Checking Betty style..."
          betty avl_trees/*.c avl_trees/*.h || (echo "âŒ Betty style errors found" && exit 1)
          echo "âœ… Betty style passed"

      - name: Compile all files
        run: |
          echo "ğŸ—ï¸ Compiling project..."
          gcc -Wall -Wextra -Werror -pedantic \
            avl_trees/binary_tree_node.c \
            avl_trees/binary_tree_print.c \
            avl_trees/0-binary_tree_is_avl.c \
            avl_trees/0-main.c \
            -I avl_trees -o avl_trees/0-is_avl
          echo "âœ… Compilation successful"

      - name: Run tests
        run: |
          echo "ğŸš€ Running binary_tree_is_avl tests..."
          ./avl_trees/0-is_avl || (echo "âŒ Runtime error" && exit 1)
          echo "âœ… Program executed successfully"

      - name: Validate output (basic pattern)
        run: |
          echo "ğŸ” Checking for expected AVL output pattern..."
          ./avl_trees/0-is_avl | grep -Eq "Is [0-9]+ avl: [01]" \
            && echo "âœ… Output format OK" \
            || (echo "âŒ Unexpected output format" && exit 1)
